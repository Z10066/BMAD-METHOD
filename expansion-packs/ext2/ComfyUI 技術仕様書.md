# ComfyUI 技術仕様書

## 1. はじめに

本ドキュメントは、ComfyUIの技術的な側面を詳細に記述することを目的としています。ComfyUIは、Stable Diffusionなどの画像生成AIを操作するための強力なモジュール式ビジュアルプログラミングインターフェースであり、その柔軟性と拡張性により、ユーザーは複雑な画像生成ワークフローを効率的に構築できます。本仕様書では、ComfyUIのシステムアーキテクチャ、主要な機能特性、技術要件、およびAPIインターフェースについて説明します。

## 2. システムアーキテクチャ

ComfyUIのシステムアーキテクチャは、ユーザーがノードベースのワークフローを視覚的に構築し、画像生成プロセスを細かく制御できるように設計されています。その核となるのは、ローカルで動作するWebサーバーと、モジュール化されたノードシステムです。

### 2.1. ローカルWebサーバー

ComfyUIは、ユーザーのローカルマシン上でWebサーバーとして動作します。これにより、特別なクラウド環境や外部サービスに依存することなく、ユーザー自身の計算リソース（特にGPU）を最大限に活用して画像生成を行うことが可能です。Webブラウザを通じてアクセス可能なユーザーインターフェースは、直感的で操作性に優れており、技術的な知識が少ないユーザーでも容易に利用できます。

### 2.2. ノードベースのビジュアルプログラミング

ComfyUIの最も特徴的な要素は、BlenderやAfter Effectsといったプロフェッショナルなツールで採用されているノードベースのビジュアルプログラミングパラダイムです。各ノードは特定のタスクや機能をカプセル化しており、例えば「モデルのロード」「プロンプトの入力」「画像のエンコード」「画像のデコード」といった個別の操作を実行します。ユーザーはこれらのノードをキャンバス上に配置し、ワイヤーで接続することで、データフローと処理順序を視覚的に定義します。このモジュール化されたアプローチにより、ワークフローの再利用性、デバッグの容易さ、および複雑なプロセスの管理が向上します。

### 2.3. モジュール性と拡張性

ComfyUIのアーキテクチャは、高度なモジュール性を備えています。各機能が独立したノードとして提供されるため、ユーザーは特定のニーズに合わせて必要なノードのみを選択し、組み合わせることができます。これにより、リソースの無駄を省き、ワークフローの効率を最大化できます。また、このモジュール性は、新しい機能やカスタムノードの追加を容易にし、コミュニティによる活発な開発と拡張を促進しています。

### 2.4. APIバックエンド

ComfyUIは、堅牢なAPIバックエンドを提供しており、外部アプリケーションやスクリプトからその機能にプログラム的にアクセスすることを可能にしています。このAPIは、ComfyUIを他のシステム（例: Webアプリケーション、自動化スクリプト、デスクトップアプリケーション）に統合するための重要なインターフェースとなります。APIを通じて、ワークフローの実行、ノードの操作、生成結果の取得など、ComfyUIのほぼすべての機能を制御できます。これにより、ComfyUIは単なるスタンドアロンツールとしてだけでなく、より大規模なAI駆動型ソリューションの一部としても機能します。

## 3. 機能特性

ComfyUIは、画像生成AIのワークフローを効率的かつ柔軟に管理するための豊富な機能セットを提供します。

### 3.1. 直感的なビジュアルワークフロー構築

ユーザーは、ドラッグ＆ドロップ操作とワイヤー接続により、複雑な画像生成プロセスを視覚的に設計できます。これにより、プログラミングの知識がなくても、Stable Diffusionの内部動作を深く理解し、制御することが可能になります。ワークフローは保存・ロードが可能であり、再利用性にも優れています。

### 3.2. 高度なカスタマイズと制御

各ノードのパラメータを細かく調整することで、画像生成のあらゆる側面を制御できます。プロンプト、サンプラー、スケジューラー、モデル、LoRA、ControlNetなど、多岐にわたる設定を柔軟に組み合わせることができ、ユーザーは独自の画像生成スタイルや品質を追求できます。

### 3.3. 包括的なモデル管理

Stable Diffusionのベースモデルだけでなく、LoRA (Low-Rank Adaptation)、Embeddings (Textual Inversion)、VAE (Variational Autoencoder) など、様々な種類のモデルをシームレスにロードし、ワークフロー内で利用できます。これにより、多様な画像スタイルやコンテンツの生成が可能になります。

### 3.4. リアルタイムプレビューとデバッグ

ワークフローの各段階での中間結果をリアルタイムで確認できる機能は、効率的な試行錯誤とデバッグに不可欠です。これにより、ユーザーは問題のあるノードやパラメータ設定を迅速に特定し、修正することができます。

### 3.5. 豊富な拡張性

ComfyUIは、カスタムノードの追加を容易にする設計思想を持っています。これにより、コミュニティ開発者は新しい機能や特殊な処理をノードとして提供し、ComfyUIのエコシステムを継続的に拡張しています。また、APIを介した外部サービスとの連携も可能であり、機能の可能性をさらに広げています。

### 3.6. プログラムによるアクセス (API)

ComfyUIのAPIは、自動化された画像生成パイプラインの構築や、他のアプリケーションへの組み込みを可能にします。これにより、バッチ処理、Webサービスとしての提供、あるいはカスタムUIの開発など、より高度な利用シナリオが実現できます。

## 4. 技術要件

ComfyUIを効果的に運用するためには、以下の技術要件を満たすシステム環境が推奨されます。

### 4.1. オペレーティングシステム

- **Windows**: Windows 10/11 (64-bit)
- **Linux**: Ubuntu 20.04 LTS以降、または同等のディストリビューション
- **macOS**: macOS 12.x (Monterey) 以降 (Apple Silicon Mシリーズチップをネイティブサポート)

### 4.2. グラフィックス処理ユニット (GPU)

画像生成AIの計算負荷は非常に高いため、高性能なGPUが必須です。

- **NVIDIA GPU**: 最も推奨される選択肢です。CUDAコアを搭載したGeForce RTXシリーズ（例: RTX 3060, RTX 3080, RTX 4090）が最適です。
  - **VRAM**: Stable Diffusionモデルの実行には、最低8GBのVRAMが必要です。より複雑なモデルや高解像度の画像を生成する場合は、12GB、24GB、またはそれ以上のVRAM（例: RTX 4090の24GB）が強く推奨されます。
- **AMD GPU**: ROCmをサポートするAMD Radeon RXシリーズも利用可能ですが、NVIDIA GPUと比較して設定が複雑になる場合や、パフォーマンスが劣る場合があります。
- **Apple Silicon**: macOS環境では、M1, M2, M3チップなどのApple SiliconのNeural Engineを活用して高速な画像生成が可能です。

### 4.3. システムメモリ (RAM)

- **推奨**: 64GB以上。特に大規模なモデル（例: SDXL）や、多数のノードを含む複雑なワークフローを同時に実行する場合、十分なシステムRAMが重要になります。
- **最小**: 16GB。ただし、この場合、パフォーマンスが低下したり、特定のワークフローが実行できなかったりする可能性があります。

### 4.4. ストレージ

- **種類**: 高速なソリッドステートドライブ (SSD) が強く推奨されます。特にNVMe SSD（PCIe Gen4x4以上）は、モデルのロード時間や画像の保存速度に大きく影響します。
- **容量**: ComfyUI本体、Stable Diffusionモデルファイル、LoRA、Embeddings、生成される画像データなど、多くのストレージ容量を必要とします。最低でも256GBの空き容量を確保し、可能であれば1TB以上のSSDを用意することが望ましいです。

### 4.5. ソフトウェア要件

- **Python**: Python 3.10以降が推奨されます。ComfyUIはPythonで記述されており、実行にはPython環境が必要です。
- **PyTorch**: GPUを活用するためには、適切なバージョンのPyTorchがインストールされている必要があります。GPUの種類（CUDA, ROCm, MPSなど）に応じて、対応するPyTorchバージョンを選択します。
- **Git**: ComfyUIのリポジトリをクローンするため、またはカスタムノードをインストールするために必要です。

## 5. APIインターフェース

ComfyUIは、そのコア機能を外部システムからプログラム的に操作するためのRESTful APIを提供しています。これにより、開発者はComfyUIを独自のアプリケーションやサービスに統合し、画像生成プロセスを自動化することが可能です。

### 5.1. APIの概要

ComfyUIのAPIは、主にノードの管理とワークフローの実行に焦点を当てています。APIを通じて、利用可能なノードの情報を取得したり、特定のノードのインストール情報を参照したりすることができます。これにより、ComfyUIの機能をヘッドレス環境で利用したり、カスタムUIを構築したりする際の基盤となります。

### 5.2. 主要なAPIエンドポイント

#### 5.2.1. ノードリスト取得API

- **エンドポイント**: `GET /nodes`
- **説明**: ComfyUIエコシステム内で利用可能なすべての公開ノードのリストを、ページネーションされた形式で返します。このAPIは、ノードの発見とカタログ化に利用されます。
- **クエリパラメータ**:
  - `page` (integer, default: 1): 取得するノードリストのページ番号。
  - `limit` (integer, default: 10): 1ページあたりのノード数。
  - `supported_os` (string): 特定のオペレーティングシステムをサポートするノードで結果をフィルタリングします。
  - `supported_accelerator` (string): 特定のGPUアクセラレータ（例: `CUDA`, `ROCm`, `MPS`）をサポートするノードで結果をフィルタリングします。
  - `include_banned` (boolean): 禁止されているノードを結果に含めるかどうかを指定します。
  - `timestamp` (string<date-time>): ISO 8601形式で指定されたタイムスタンプ以降に作成または更新されたノードを取得します。
  - `latest` (boolean): データベースから最新の結果をフェッチするか、キャッシュされた結果を使用するかを指定します。
  - `sort` (string[]): 結果をソートするためのデータベース列を指定します。降順の場合は列名に`;desc`サフィックスを追加します。
  - `node_id` (string[]): 特定のノードIDで結果をフィルタリングします。
  - `comfyui_version` (string): 特定のComfyUIバージョンと互換性のあるノードで結果をフィルタリングします。
  - `form_factor` (string): ノードを要求しているプラットフォーム（例: `desktop`, `mobile`, `cloud`）を指定します。
- **レスポンス**: 成功した場合、HTTP 200 OKとともに、ノードのメタデータを含むJSON配列を返します。各ノードオブジェクトには、`author`, `banner_url`, `category`, `description`, `downloads`, `github_stars`, `id`, `name`, `publisher`, `repository`, `status`, `supported_os`, `supported_accelerators`, `tags`, `latest_version` などの詳細情報が含まれます。`latest_version`オブジェクトには、`changelog`, `dependencies`, `downloadUrl`, `version` などのバージョン固有の情報が含まれます。

#### 5.2.2. ノードインストール情報取得API

- **エンドポイント**: `GET /nodes/{nodeId}/install`
- **説明**: 特定のノードのインストールに必要な情報（ダウンロードURL、依存関係など）を取得します。これにより、プログラムによるノードの自動インストールや更新が可能になります。
- **パスパラメータ**:
  - `nodeId` (string, required): インストール情報を取得したいノードの一意の識別子。
- **クエリパラメータ**:
  - `version` (string, optional): 取得したいノードの特定のバージョンを指定します。省略した場合、そのノードの最新バージョン情報が返されます。
- **レスポンス**: 成功した場合、HTTP 200 OKとともに、指定されたノードバージョンの詳細情報を含むJSONオブジェクトを返します。これには、`changelog`, `comfy_node_extract_status`, `createdAt`, `dependencies` (pipパッケージのリスト), `deprecated`, `downloadUrl`, `id`, `node_id`, `status`, `status_reason`, `supported_accelerators`, `supported_comfyui_frontend_version`, `supported_comfyui_version`, `supported_os`, `version` などが含まれます。

### 5.3. APIの利用シナリオ

ComfyUIのAPIは、以下のような多様な利用シナリオをサポートします。

- **カスタムフロントエンドの開発**: 独自のWebアプリケーションやデスクトップアプリケーションからComfyUIのバックエンド機能を呼び出し、カスタムユーザーインターフェースを提供します。
- **自動化されたワークフロー**: 定期的な画像生成タスク、バッチ処理、または特定のイベントトリガーに基づく画像生成パイプラインを構築します。
- **クラウドベースのサービス**: ComfyUIをバックエンドとして利用し、画像生成サービスをクラウド上で提供します。
- **研究と開発**: 新しい画像生成アルゴリズムやモデルをComfyUIのフレームワーク内でテストし、その結果をプログラム的に分析します。

## 6. 結論

ComfyUIは、そのモジュール化されたアーキテクチャ、直感的なビジュアルプログラミングインターフェース、そして包括的なAPIにより、画像生成AIの分野において非常に強力で柔軟なツールとなっています。本技術仕様書が、ComfyUIの技術的な理解を深め、その機能を最大限に活用するための一助となることを期待します。

---

**著者**: Manus AI
**最終更新日**: 2025年9月10日
